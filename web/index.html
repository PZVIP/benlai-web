<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Benlai PWA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* å…¨å±€èƒŒæ™¯è®¾ä¸ºæ·±è‰²ï¼Œé˜²æ­¢ PC ç«¯ä¸¤ä¾§ç•™ç™½å¤ªåˆºçœ¼ */
        html { background-color: #010409; }

        body { 
            background-color: #0d1117; 
            color: #c9d1d9; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; 
            padding: 20px 20px 80px 20px; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            box-sizing: border-box; 
        }
        
        h1 { font-size: 1.1rem; color: #8b949e; margin: 0 0 20px 0; }
        
        /* === ğŸ“± PC ç«¯é€‚é…æ ¸å¿ƒä»£ç  === */
        @media (min-width: 768px) {
            body {
                width: 30%;          /* å¼ºåˆ¶å æµè§ˆå™¨ 1/2 å®½åº¦ */
                margin: 0 auto;      /* å±…ä¸­æ˜¾ç¤º */
                border-left: 1px solid #30363d;
                border-right: 1px solid #30363d;
                box-shadow: 0 0 50px rgba(0,0,0,0.5); /* å¢åŠ é˜´å½±æå‡è´¨æ„Ÿ */
            }
            
            /* å¯¼èˆªæ ä¹Ÿè¦è·Ÿç€å±…ä¸­å¹¶é™åˆ¶å®½åº¦ */
            .nav-bar {
                width: 50% !important; 
                left: 50% !important; 
                transform: translateX(-50%);
            }
        }
        /* ============================ */

        /* å¯¼èˆª */
        .nav-bar { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: #161b22; 
            border-top: 1px solid #30363d; 
            display: flex; justify-content: space-around; padding: 12px; z-index: 100;
        }
        .nav-item { cursor: pointer; opacity: 0.5; font-size: 24px; text-align: center; }
        .nav-item.active { opacity: 1; color: #58a6ff; }
        .nav-text { display: block; font-size: 10px; margin-top: 4px; }

        .page { display: none; height: 100%; overflow-y: auto; }
        .page.active { display: block; }
        
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .page::-webkit-scrollbar { width: 0px; background: transparent; }

        /* å†™å…¥é¡µ */
        .type-selector { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .type-selector::-webkit-scrollbar { height: 0px; }
        .type-btn { background: #21262d; border: 1px solid #30363d; color: #8b949e; padding: 6px 12px; border-radius: 20px; font-size: 13px; white-space: nowrap; cursor: pointer; transition: 0.2s;}
        .type-btn:hover { background: #30363d; }
        .type-btn.active { background: #1f6feb; color: #fff; border-color: #1f6feb; }
        textarea { width: 100%; background: #161b22; border: 1px solid #30363d; border-radius: 12px; color: #fff; padding: 15px; font-size: 16px; min-height: 200px; box-sizing: border-box; margin-bottom: 20px; resize: none; }
        textarea:focus { outline: 1px solid #1f6feb; }
        .btn { background: #238636; color: #fff; border: none; padding: 15px; border-radius: 12px; font-size: 16px; width: 100%; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn:hover { background: #2ea043; }
        .btn:disabled { background: #21262d; opacity: 0.6; cursor: not-allowed; }

        /* å¯¹è¯é¡µ */
        .chat-box { display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; }
        .msg { padding: 12px 16px; border-radius: 12px; max-width: 85%; line-height: 1.5; font-size: 15px; word-wrap: break-word; }
        .msg.user { background: #1f6feb; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg.ai { background: #21262d; border: 1px solid #30363d; align-self: flex-start; border-bottom-left-radius: 2px; }
        .chat-input { display: flex; gap: 10px; margin-top: 10px; }
        .chat-input input { flex: 1; background: #161b22; border: 1px solid #30363d; color: white; padding: 12px; border-radius: 25px; outline: none; }
        .chat-input input:focus { border-color: #1f6feb; }
        .send-icon { background: #1f6feb; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .send-icon:hover { background: #388bfd; }

        /* è®¾ç½®é¡µ */
        .settings input { width: 100%; padding: 12px; margin-bottom: 15px; background: #0d1117; border: 1px solid #30363d; color: #fff; border-radius: 8px; box-sizing: border-box; outline: none; }
        .settings input:focus { border-color: #1f6feb; }
        .label { font-size: 12px; color: #8b949e; margin-bottom: 6px; display: block; }
    </style>
</head>
<body>

    <div id="page-write" class="page active">
        <h1>Benlai ğŸ“</h1>
        <div class="type-selector">
            <div class="type-btn active" onclick="setType('note')">ç¬”è®°</div>
            <div class="type-btn" onclick="setType('transaction')">äº¤æ˜“</div>
            <div class="type-btn" onclick="setType('journal')">æ—¥è®°</div>
            <div class="type-btn" onclick="setType('checkin')">æ‰“å¡</div>
        </div>
        <textarea id="content" placeholder="è®°å½•å½“ä¸‹çš„æƒ³æ³•..."></textarea>
        <button class="btn" id="sendBtn" onclick="upload()">å‘é€è®°å½•</button>
    </div>

    <div id="page-chat" class="page">
        <h1>Memory ğŸ§ </h1>
        <div class="chat-box" id="chatHistory">
            <div class="msg ai">æˆ‘æ˜¯ä½ çš„ DeepSeek æ•°å­—åˆ†èº«ã€‚æˆ‘å·²ç»å‡†å¤‡å¥½è¯»å–ä½ çš„åŠ å¯†è®°å¿†ï¼Œæƒ³é—®ä»€ä¹ˆï¼Ÿ</div>
        </div>
        <div class="chat-input">
            <input type="text" id="askInput" placeholder="æœå›å¿†: ä¸Šå‘¨äºŒåšäº†ä»€ä¹ˆ?" onkeypress="if(event.keyCode==13) askDeepSeek()">
            <div class="send-icon" onclick="askDeepSeek()">â¤</div>
        </div>
    </div>

    <div id="page-settings" class="page">
        <h1>Settings âš™ï¸</h1>
        <div class="settings">
            <label class="label">æ•°æ®ä»“åº“ Owner (e.g. PZVIP)</label>
            <input id="gh_owner" placeholder="Owner">
            
            <label class="label">æ•°æ®ä»“åº“ Repo (e.g. mylife)</label>
            <input id="gh_repo" placeholder="Repo">
            
            <label class="label">GitHub Token (ghp_...)</label>
            <input id="gh_token" type="password" placeholder="ç”¨äºè¯»å†™ç§æœ‰æ•°æ®">
            
            <label class="label">DeepSeek é…ç½® (ç”¨äºèŠå¤©)</label>
            <input id="ds_key" type="password" placeholder="DeepSeek API Key (sk-...)">
            
            <label class="label">è®°å¿†ä¿é™©ç®± (ç”¨äºè§£å¯†)</label>
            <input id="mem_pass" type="password" placeholder="Memory Password">
            
            <button class="btn" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="nav('write')">ğŸ“<span class="nav-text">è®°å½•</span></div>
        <div class="nav-item" onclick="nav('chat')">ğŸ’¬<span class="nav-text">å›å¿†</span></div>
        <div class="nav-item" onclick="nav('settings')">âš™ï¸<span class="nav-text">è®¾ç½®</span></div>
    </div>

    <script>
        let curType = 'note';
        let memories = [];
        let locationData = null;

        window.onload = () => {
            ['gh_owner','gh_repo','gh_token','ds_key','mem_pass'].forEach(k => {
                if(localStorage.getItem(k)) document.getElementById(k).value = localStorage.getItem(k);
            });
            if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p => locationData = p.coords);
        };

        function nav(p) {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active');
            event.currentTarget.classList.add('active');
            if(p === 'chat') loadMemories();
        }

        function setType(t) {
            curType = t;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function saveSettings() {
            ['gh_owner','gh_repo','gh_token','ds_key','mem_pass'].forEach(k => {
                localStorage.setItem(k, document.getElementById(k).value.trim());
            });
            alert('âœ… é…ç½®å·²ä¿å­˜');
            location.reload();
        }

        async function upload() {
            const content = document.getElementById('content').value;
            if(!content) return;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('sendBtn').innerText = "ä¸Šä¼ ä¸­...";

            const now = new Date();
            const payload = {
                meta: { ver: "3.0", ts: Math.floor(now.getTime()/1000), iso_time: now.toISOString(), source: "pwa_web" },
                event: { type: curType, content: content },
                micro: { geo: locationData ? { coords:[locationData.latitude, locationData.longitude] } : null },
                macro: {}
            };

            const path = `inbox/${now.toISOString().replace(/[:.]/g,'-')}.json`;
            const url = `https://api.github.com/repos/${localStorage.getItem('gh_owner')}/${localStorage.getItem('gh_repo')}/contents/${path}`;
            
            try {
                await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${localStorage.getItem('gh_token')}` },
                    body: JSON.stringify({
                        message: `ğŸ“± ${curType}`,
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(payload))))
                    })
                });
                alert('âœ… è®°å½•æˆåŠŸ');
                document.getElementById('content').value = '';
            } catch(e) { alert('âŒ é”™è¯¯:'+e); }
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('sendBtn').innerText = "å‘é€è®°å½•";
        }

        async function loadMemories() {
            if(memories.length > 0) return;
            
            const owner = localStorage.getItem('gh_owner');
            const repo = localStorage.getItem('gh_repo');
            const token = localStorage.getItem('gh_token');
            const pass = localStorage.getItem('mem_pass');

            if(!owner || !repo || !token || !pass) return addMsg("âš ï¸ è¯·å…ˆåœ¨è®¾ç½®é‡Œå¡«å†™å®Œæ•´çš„ä»“åº“ä¿¡æ¯å’Œå¯†ç ", 'ai');

            try {
                addMsg("ğŸ” æ­£åœ¨ä»è¿œç¨‹ä»“åº“ä¸‹è½½å¹¶è§£å¯†è®°å¿†...", 'ai');
                
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/web/memory.lock?ref=main`; 
                const res = await fetch(url, {
                    headers: { 'Authorization': `token ${token}` }
                });

                if(!res.ok) throw new Error("æ— æ³•è¿æ¥æ•°æ®ä»“åº“ (404/403) - è¯·æ£€æŸ¥ Token å’Œ Repo");
                
                const data = await res.json();
                const encryptedContent = window.atob(data.content.replace(/\n/g, ""));
                
                const key = CryptoJS.SHA256(pass);
                const raw = CryptoJS.enc.Base64.parse(encryptedContent);
                const iv = CryptoJS.lib.WordArray.create(raw.words.slice(0, 4));
                const cipher = CryptoJS.lib.WordArray.create(raw.words.slice(4));
                
                const decrypted = CryptoJS.AES.decrypt({ ciphertext: cipher }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
                const json = decrypted.toString(CryptoJS.enc.Utf8);
                
                if(!json) throw new Error("å¯†ç é”™è¯¯æˆ–æ•°æ®æŸå");
                
                memories = JSON.parse(json);
                addMsg(`ğŸ”“ æˆåŠŸåŠ è½½ ${memories.length} æ¡è®°å¿†ï¼`, 'ai');

            } catch(e) { 
                console.error(e);
                addMsg("âŒ åŠ è½½å¤±è´¥: " + e.message, 'ai'); 
            }
        }

        async function askDeepSeek() {
            const q = document.getElementById('askInput').value;
            if(!q) return;
            addMsg(q, 'user');
            document.getElementById('askInput').value = '';
            
            const key = localStorage.getItem('ds_key');
            if(!key) return addMsg("è¯·é…ç½® DeepSeek Key", 'ai');

            const context = memories.slice(0, 50).map(m => `[${m.d}] ${m.c} (Env:${m.w},${m.m})`).join('\n');

            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${key}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {role: "system", content: `ä½ æ˜¯ä¸€ä¸ªè®°å¿†åŠ©æ‰‹ã€‚åŸºäºä»¥ä¸‹ç”¨æˆ·æ—¥è®°å›ç­”é—®é¢˜:\n${context}`},
                            {role: "user", content: q}
                        ]
                    })
                });
                const data = await res.json();
                addMsg(data.choices[0].message.content, 'ai');
            } catch(e) { addMsg("âŒ æ€è€ƒå¤±è´¥: "+e, 'ai'); }
        }

        function addMsg(txt, role) {
            const d = document.createElement('div');
            d.className = `msg ${role}`;
            d.innerText = txt;
            document.getElementById('chatHistory').appendChild(d);
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
    </script>
</body>
</html>