<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Personal Blackbox</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --text: #e0e0e0;
            --accent: #bb86fc;
            --secondary: #03dac6;
            --error: #cf6679;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* åº•éƒ¨å¯¼èˆª */
        .nav {
            display: flex;
            background: var(--card);
            padding: 10px 0;
            border-top: 1px solid #333;
            justify-content: space-around;
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
            color: #888;
            cursor: pointer;
            transition: 0.3s;
        }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }

        /* å†…å®¹å®¹å™¨ */
        .page {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: none;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        .page.active { display: block; }

        /* è®°å½•é¡µ */
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #bbb; }
        textarea, input, select {
            width: 100%;
            background: #2a2a2a;
            border: 1px solid #444;
            color: #fff;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
        }
        textarea { height: 150px; resize: none; }
        button {
            width: 100%;
            background: var(--accent);
            color: #000;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* è®°å¿†é¡µ (å¯¹è¯æ ·å¼) */
        .chat-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 80px; }
        .msg { padding: 12px; border-radius: 12px; max-width: 85%; line-height: 1.5; font-size: 15px; }
        .msg.user { background: var(--accent); color: #000; align-self: flex-end; }
        .msg.ai { background: var(--card); color: var(--text); align-self: flex-start; border: 1px solid #333; }
        .chat-input-area {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 600px;
            padding: 10px;
            background: var(--bg);
            display: flex;
            gap: 10px;
        }

        /* è®¾ç½®é¡µ */
        .settings-card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .settings-card h3 { margin-top: 0; color: var(--accent); font-size: 16px; }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        #status { font-size: 12px; text-align: center; margin-top: 10px; color: #666; }
    </style>
</head>
<body>

    <!-- 1. è®°å½•é¡µ -->
    <div id="page-record" class="page active">
        <h2 style="color: var(--accent)">ğŸ“¥ è®°å½•æ–°ä¿¡æ¯</h2>
        <div class="input-group">
            <label>ç±»å‹</label>
            <select id="type">
                <option value="quick_log">ğŸ“ éšæ‰‹è®°</option>
                <option value="thought">ğŸ’¡ æƒ³æ³•</option>
                <option value="event">ğŸ“… äº‹ä»¶</option>
                <option value="finance">ğŸ’° è´¢åŠ¡</option>
            </select>
        </div>
        <div class="input-group">
            <label>å†…å®¹</label>
            <textarea id="content" placeholder="è®°å½•è¿™ä¸€åˆ»..."></textarea>
        </div>
        <button id="sendBtn" onclick="sendRecord()">å‘é€åˆ° Inbox</button>
        <div id="status"></div>
    </div>

    <!-- 2. è®°å¿†é¡µ -->
    <div id="page-memories" class="page">
        <h2 style="color: var(--secondary)">ğŸ§  æ·±åº¦è®°å¿†</h2>
        <div id="chatHistory" class="chat-container">
            <div class="msg ai">ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„è®°å¿†åŠ©æ‰‹ã€‚é…ç½®å¥½ä»“åº“å’Œå¯†ç åï¼Œæˆ‘å¯ä»¥å¸®ä½ æ£€ç´¢è¿‡å»çš„ä¿¡æ¯ã€‚</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="askInput" placeholder="é—®é—®è¿‡å»çš„äº‹æƒ…..." onkeydown="if(event.key==='Enter') askDeepSeek()">
            <button style="width: 80px; padding: 10px;" onclick="askDeepSeek()">å‘é€</button>
        </div>
    </div>

    <!-- 3. è®¾ç½®é¡µ -->
    <div id="page-settings" class="page">
        <h2 style="color: #888">âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
        <div class="settings-card">
            <h3>GitHub ä»“åº“é…ç½®</h3>
            <input type="text" id="gh_owner" placeholder="GitHub ç”¨æˆ·å (å¦‚: PZVIP)" style="margin-bottom: 10px;">
            <input type="text" id="gh_repo" placeholder="ä»“åº“å (å¦‚: mylife)" style="margin-bottom: 10px;">
            <input type="password" id="gh_token" placeholder="Personal Access Token (Classic)" style="margin-bottom: 10px;">
        </div>
        <div class="settings-card">
            <h3>åŠ å¯†ä¸ AI é…ç½®</h3>
            <input type="password" id="mem_pass" placeholder="è®°å¿†è§£å¯†å¯†ç  (MEMORY_PASSWORD)" style="margin-bottom: 10px;">
            <input type="password" id="ds_key" placeholder="DeepSeek API Key" style="margin-bottom: 10px;">
        </div>
        <button onclick="saveSettings()" style="background: #444; color: #fff;">ä¿å­˜è®¾ç½®</button>
        <p style="font-size: 11px; color: #555; margin-top: 15px;">* è®¾ç½®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ° (LocalStorage)ï¼Œè¯·ç¡®ä¿åœ¨ HTTPS ç¯å¢ƒä¸‹ä½¿ç”¨ã€‚</p>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="nav">
        <div class="nav-item active" onclick="showPage('record', this)">
            <span class="nav-icon">ğŸ“</span>
            <span>è®°å½•</span>
        </div>
        <div class="nav-item" onclick="showPage('memories', this)">
            <span class="nav-icon">ğŸ§ </span>
            <span>è®°å¿†</span>
        </div>
        <div class="nav-item" onclick="showPage('settings', this)">
            <span class="nav-icon">âš™ï¸</span>
            <span>è®¾ç½®</span>
        </div>
    </div>

    <script>
        let memories = [];

        // åˆå§‹åŒ–åŠ è½½è®¾ç½®
        window.onload = () => {
            ['gh_owner', 'gh_repo', 'gh_token', 'mem_pass', 'ds_key'].forEach(id => {
                document.getElementById(id).value = localStorage.getItem(id) || '';
            });
        };

        function showPage(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${id}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            if(id === 'memories') loadMemories();
        }

        function saveSettings() {
            ['gh_owner', 'gh_repo', 'gh_token', 'mem_pass', 'ds_key'].forEach(id => {
                localStorage.setItem(id, document.getElementById(id).value);
            });
            alert('âœ… è®¾ç½®å·²ä¿å­˜');
        }

        async function sendRecord() {
            const content = document.getElementById('content').value;
            const type = document.getElementById('type').value;
            if(!content) return alert('è¯·è¾“å…¥å†…å®¹');

            const owner = localStorage.getItem('gh_owner');
            const repo = localStorage.getItem('gh_repo');
            const token = localStorage.getItem('gh_token');
            if(!owner || !repo || !token) return alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® GitHub ä¿¡æ¯');

            const btn = document.getElementById('sendBtn');
            btn.disabled = true;
            btn.innerText = "æ­£åœ¨å‘é€...";

            const now = new Date();
            const payload = {
                meta: { ver: "3.0", ts: Math.floor(now.getTime()/1000), iso_time: now.toISOString(), source: "pwa_web" },
                event: { type: type, content: content, tags: [] },
                micro: {}, macro: {}
            };

            const path = `inbox/${now.toISOString().replace(/[:.]/g,'-')}.json`;
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;

            try {
                const res = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `ğŸ“± ${type} from web`,
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(payload))))
                    })
                });

                if(!res.ok) {
                    const err = await res.json();
                    throw new Error(err.message || 'æäº¤å¤±è´¥');
                }

                alert('âœ… è®°å½•æˆåŠŸï¼ETL å°†åœ¨å‡ åˆ†é’Ÿå†…å¤„ç†');
                document.getElementById('content').value = '';
            } catch(e) {
                alert('âŒ å‘é€å¤±è´¥: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "å‘é€åˆ° Inbox";
            }
        }

        async function loadMemories() {
            if(memories.length > 0) return;
            
            const owner = localStorage.getItem('gh_owner');
            const repo = localStorage.getItem('gh_repo');
            const token = localStorage.getItem('gh_token');
            const pass = localStorage.getItem('mem_pass');

            if(!owner || !repo || !token || !pass) {
                return addMsg("âš ï¸ è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™å®Œæ•´çš„ä»“åº“ä¿¡æ¯å’Œå¯†ç ", 'ai');
            }

            try {
                addMsg("ğŸ” æ­£åœ¨ä»è¿œç¨‹ä»“åº“ä¸‹è½½å¹¶è§£å¯†è®°å¿†...", 'ai');
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/web/memory.lock?ref=main`; 
                const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });

                if(!res.ok) throw new Error("æ— æ³•è·å–æ•°æ® (æ£€æŸ¥ Token/Repo)");
                
                const data = await res.json();
                const encryptedBase64 = data.content.replace(/\n/g, "");
                
                // è§£å¯†é€»è¾‘ (AES-256-CBC)
                const key = CryptoJS.SHA256(pass);
                const rawData = CryptoJS.enc.Base64.parse(encryptedBase64);
                const iv = CryptoJS.lib.WordArray.create(rawData.words.slice(0, 4));
                const ciphertext = CryptoJS.lib.WordArray.create(rawData.words.slice(4));
                
                const decrypted = CryptoJS.AES.decrypt({ ciphertext: ciphertext }, key, { 
                    iv: iv, 
                    mode: CryptoJS.mode.CBC, 
                    padding: CryptoJS.pad.Pkcs7 
                });
                
                const jsonStr = decrypted.toString(CryptoJS.enc.Utf8);
                if(!jsonStr) throw new Error("è§£å¯†å¤±è´¥ (å¯†ç å¯èƒ½é”™è¯¯)");
                
                memories = JSON.parse(jsonStr);
                addMsg(`ğŸ”“ æˆåŠŸåŠ è½½ ${memories.length} æ¡è®°å¿†ï¼`, 'ai');
            } catch(e) { 
                addMsg("âŒ åŠ è½½å¤±è´¥: " + e.message, 'ai'); 
            }
        }

        async function askDeepSeek() {
            const q = document.getElementById('askInput').value;
            const key = localStorage.getItem('ds_key');
            if(!q || !key) return alert('è¯·è¾“å…¥é—®é¢˜å¹¶ç¡®ä¿é…ç½®äº† DeepSeek Key');

            addMsg(q, 'user');
            document.getElementById('askInput').value = '';

            // è·å–æœ€è¿‘ 50 æ¡è®°å¿†ä½œä¸ºä¸Šä¸‹æ–‡
            const context = memories.slice(0, 50).map(m => `[${m.d}] ${m.c}`).join('\n');

            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${key}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {role: "system", content: `ä½ æ˜¯ä¸€ä¸ªè®°å¿†åŠ©æ‰‹ã€‚åŸºäºä»¥ä¸‹ç”¨æˆ·çš„å†å²è®°å¿†å›ç­”é—®é¢˜ã€‚å¦‚æœæ²¡æ‰¾åˆ°ç›¸å…³å†…å®¹ï¼Œè¯·å¦‚å®å‘ŠçŸ¥ã€‚è®°å¿†å†…å®¹ï¼š\n${context}`},
                            {role: "user", content: q}
                        ]
                    })
                });
                const data = await res.json();
                addMsg(data.choices[0].message.content, 'ai');
            } catch(e) { addMsg("âŒ æ€è€ƒå¤±è´¥: "+e, 'ai'); }
        }

        function addMsg(txt, role) {
            const d = document.createElement('div');
            d.className = `msg ${role}`;
            d.innerText = txt;
            const history = document.getElementById('chatHistory');
            history.appendChild(d);
            history.scrollTop = history.scrollHeight;
        }
    </script>
</body>
</html>
